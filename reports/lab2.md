# Lab2 实验报告

2019011215 任彦羽

## 功能简介

1. 在`MemSet`中实现判断某一段区间中的虚拟页码是否全部/全未在某一个`area`当中被映射的接口`check_before_map`和`check_before_unmap`
2. 在`Memset`中实现将某一段去接内的虚拟页码映射到物理页码的接口`seq_mem_map`和`seq_mem_unmap`
3. 在`mm\pagetable.rs`中实现可根据`token`和`va`来给出一个引用的泛型函数`get_easy_ptr`
4. 在`syscall\process.rs`中使用上述接口实现对应的syscall功能，特别地对于`sys_mmap`还要对`start`是否页对齐、`port`是否合理并转为`MapPermission`

## 简答题

```nginx
声明：官方实验指导书第四章（https://rcore-os.github.io/rCore-Tutorial-Book-v3/chapter4/index.html）有相应问答题的答案，以下答案中一部分对照该答案进行了修正，特此声明。
```

1. 请列举 SV39 页表页表项的组成，描述其中的标志位有何作用？

   SV39页表（自63至0）包括10-bit保留区[63:54]，26-bit PPN[2], 9-bit PPN[1], 9-bit PPN[0],([53:10] 物理页号) 2-bit RSW以及依次1-bit的标志位D,A,G,U,X,W,R,V（[7:0] 标志位）

   其中V表示页表项是否合法；R/W/X分别表示页表项所对应的虚拟页面是否允许读/写/取指（执行）；U表示页表项所对应的虚拟页面可否在用户态下访问；G是全局标志位；A记录自从页表项上的这一位被清零之后，页表项的对应虚拟页面是否被访问过；D 则记录自从页表项上的这一位被清零之后，页表项的对应虚拟页表是否被修改过。

2. 请问哪些异常可能是缺页导致的？

   在当前的实验阶段可能会导致`StoreFault`(exception code, ec:6)和`StorePageFault`(ec:10)以及`LoadPageFault`(ec:11)。

   在实际的riscv处理器中可能会引发指令缺页异常(ec:12),store/AMO缺页异常(ec:15)，load缺页异常(ec:13)。

3. 发生缺页时，描述相关重要寄存器的值，上次实验描述过的可以简略。

   scause: 中断/异常发生时，CSR 寄存器 scause 中会记录其信息，Interrupt 位记录是中断还是异常，Exception Code 记录中断/异常的种类。具体的ec见上。
   stvec: 记录处理 trap 的入口地址，现有两种模式`Direct`和`Vectored`，本实验中为`Direct`。
   stval: trap 发生进入S态时会将异常信息写入，用于帮助处理 trap，在发生缺页异常时其中会保存导致异常的虚拟地址。
   sstatus，sepc，sscratch 上次实验已经描述过。

4. Lazy策略有哪些好处？

   可以节省内存空间，防止加载未被使用或者会被替代的页面，减少单次加载的数据量，节约时间，提升运行效率。

5. 处理 10G 连续的内存页面，对应的 SV39 页表大致占用多少内存 (估算数量级即可)？

   大约是`10GB/4096B*8B=20MB`

6. 请简单思考如何才能实现 Lazy 策略，缺页时又如何处理？描述合理即可，不需要考虑实现。

   分配内存时暂时不对之分配，只是将在磁盘（或者其他外设）的位置记录下来，访问缺页时会触发缺页异常，在 `trap_handler` 中处理相应的异常时再将之从磁盘（或者其他外设中）加载到内存中并分配物理内存空间。

7. 使用swap策略时，页面失效如何表现在页表项(PTE)上？

   将V标志位置0.

8. 在单页表情况下，如何更换页表？

   直接更改satp的值即可。

9. 单页表情况下，如何控制用户态无法访问内核页面？（tips:看看上一题最后一问）

     将内核页面对应的 PTE 的 U 标志位设置为0。

10. 单页表有何优势？（回答合理即可）

     在内核和用户态之间转换时不需要更换页表，因而不需要设计跳板，可以像之前一样直接简单地切换上下文，节省了一部分空间。

11. 双页表实现下，何时需要更换页表？假设你写一个单页表操作系统，你会选择何时更换页表（回答合理即可）？

      双页表实现下用户程序和内核转换时、用户程序转换时都需要更换页表，而对于单页表操作系统，仅有切换任务（用户线程？）时需要更换页表。
